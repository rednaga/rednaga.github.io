<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hacking with dex-oracle for Android Malware Deobfuscation | RedNaga Security</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="About a month or two ago, someone asked me to analyze some obfuscated Android malware. Recently, I finally had a chance to take a look. I ended up using dex-oracle along with some tricks to partially">
<meta property="og:type" content="article">
<meta property="og:title" content="Hacking with dex-oracle for Android Malware Deobfuscation">
<meta property="og:url" content="https://rednaga.io/2017/10/28/hacking-with-dex-oracle-for-android-malware-deobfuscation/index.html">
<meta property="og:site_name" content="RedNaga Security">
<meta property="og:description" content="About a month or two ago, someone asked me to analyze some obfuscated Android malware. Recently, I finally had a chance to take a look. I ended up using dex-oracle along with some tricks to partially">
<meta property="og:image" content="https://rednaga.io/images/hacking-with-dex-oracle-for-android-malware-deobfuscation/class_list.png">
<meta property="og:image" content="https://rednaga.io/images/hacking-with-dex-oracle-for-android-malware-deobfuscation/obfuscated_method.png">
<meta property="og:image" content="https://rednaga.io/images/hacking-with-dex-oracle-for-android-malware-deobfuscation/d_partially_deobfuscated.png">
<meta property="og:image" content="https://rednaga.io/images/hacking-with-dex-oracle-for-android-malware-deobfuscation/get_rekt.gif">
<meta property="og:image" content="https://rednaga.io/images/hacking-with-dex-oracle-for-android-malware-deobfuscation/d_deobfuscated.png">
<meta property="og:updated_time" content="2017-10-29T00:30:34.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hacking with dex-oracle for Android Malware Deobfuscation">
<meta name="twitter:description" content="About a month or two ago, someone asked me to analyze some obfuscated Android malware. Recently, I finally had a chance to take a look. I ended up using dex-oracle along with some tricks to partially">
<meta name="twitter:image" content="https://rednaga.io/images/hacking-with-dex-oracle-for-android-malware-deobfuscation/class_list.png">
<meta name="twitter:creator" content="@RedNagaSec">
  
    <link rel="alternative" href="/rss2.xml" title="RedNaga Security" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-81741124-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">RedNaga Security</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">spicy security research</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/rss2.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://rednaga.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-hacking-with-dex-oracle-for-android-malware-deobfuscation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/10/28/hacking-with-dex-oracle-for-android-malware-deobfuscation/" class="article-date">
  <time datetime="2017-10-28T07:00:00.000Z" itemprop="datePublished">2017-10-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Hacking with dex-oracle for Android Malware Deobfuscation
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>About a month or two ago, someone asked me to analyze some obfuscated Android malware. Recently, I finally had a chance to take a look. I ended up using <a href="https://github.com/CalebFenton/dex-oracle" target="_blank" rel="external">dex-oracle</a> along with some tricks to partially deobfuscate it. In this post, I’m going to explain the tricks and the overall process I used. This post will be useful if you deal with a lot of obfuscated Android apps.</p>
<p>The main problem was dex-oracle didn’t work “out of the box”. It took some “hacking” to make it work. Specifically, I modified an existing deobfuscation plugin to create two new plugins as well as slightly modify the app. It’s really hard to make completely generalized deobfuscation tools, or any kind of advanced tool, so you’ll need to know how it works in order to modify it to suit your needs.<br><a id="more"></a></p>
<h2 id="The-Sample"><a href="#The-Sample" class="headerlink" title="The Sample"></a>The Sample</h2><p>Here’s the SHA256:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ shasum <span class="_">-a</span> 256 xjmurla.gqscntaej.bfdiays.apk</div><div class="line">d3becbee846560d0ffa4f3cda708d69a98dff92785b7412d763f810c51c0b091  xjmurla.gqscntaej.bfdiays.apk</div></pre></td></tr></table></figure>
<h2 id="High-Level-Analysis"><a href="#High-Level-Analysis" class="headerlink" title="High-Level Analysis"></a>High-Level Analysis</h2><p>I like to start with a decompilation just to get a high level overview of the package structure. Here’s what the class list:</p>
<p><img src="/images/hacking-with-dex-oracle-for-android-malware-deobfuscation/class_list.png" alt="class list"></p>
<p>Some class names have been ProGuard’ed (<code>a</code>, <code>b</code>, <code>c</code>, etc.) but some haven’t (<code>Ceacbcbf</code>). These unobfuscated classes are probably Android components (activity, service, broadcast receiver, etc.) which must be declared in the manifest. Thus, any tool which automatically renames them would also have to rename them in the manifest, which is hard. These may have been manually changed. The obfuscation is probably home-made and partially done by hand. This means it’s probably malicious because a legit developer would probably pull a commercial obfuscator off the shelf and just use that. They wouldn’t waste time changing their class names to something indecipherable like <code>Aeabffdccdac</code>.</p>
<p>The code is obfuscated. Below is a class which shows the obfuscation:</p>
<p><img src="/images/hacking-with-dex-oracle-for-android-malware-deobfuscation/obfuscated_method.png" alt="obfuscated method decompilation"></p>
<p>You can’t see any strings or class names, which is really annoying. This looks like something <a href="https://github.com/CalebFenton/simplify" target="_blank" rel="external">Simplify</a> can handle, but, <em>spoilers</em>, it fails miserably. That’s fine. I have many tricks up my sleeve. Let’s take a look at the Smali and see if anything jumps out.</p>
<h2 id="String-and-Class-Obfuscation"><a href="#String-and-Class-Obfuscation" class="headerlink" title="String and Class Obfuscation"></a>String and Class Obfuscation</h2><p>The first type of obfuscation which jumped out at me was an “indexed string lookup” type obfuscation.</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">const v2, 0x320fb26f<span class="built_in"></span></div><div class="line">invoke-static &#123;v2&#125;, <span class="class">Lxjmurla/gqscntaej/bfdiays/f;</span>-&gt;a(I)<span class="class">Ljava/lang/String;</span><span class="built_in"></span></div><div class="line">move-result-object v2</div></pre></td></tr></table></figure>
<p>This pattern is found hundreds of times in the code. It takes a number, passes it to <code>f.a(int)</code>, and gets a string back. This is some basic “level 1” style encryption. There’s probably a big method somewhere which builds an array of strings that the number indexes into.</p>
<p>A second type of obfuscation hides class constants using an identical technique:</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">const v1, 0x19189b07<span class="built_in"></span></div><div class="line">invoke-static &#123;v1&#125;, <span class="class">Lxjmurla/gqscntaej/bfdiays/g;</span>-&gt;c(I)<span class="class">Ljava/lang/Class;</span><span class="built_in"></span></div><div class="line">move-result-object v1</div></pre></td></tr></table></figure>
<p>This code passes a number to <code>g.c(int)</code> and gets back a class object (<code>const-class</code>).</p>
<p>You may be thinking you’ll have to reverse engineer the lookup methods, and you’d be wrong. It’s cool and all to deep dive into the complex code and completely master it by writing a decryption routine. But honestly, fuck that. Speed is the name of the game, and I really don’t have time to fuck around with this malware author’s bullshit, retarded, home-made, amateur hour obfuscation. Instead of reversing everything, consider that these “lookup” methods are both <em>static</em>. It should be possible to just execute them with the same inputs from the code to get back the decrypted output. For example, in the case of string decryption, I should be able to execute <code>f.a(0x320fb26f)</code> and get back the decrypted string.</p>
<p>The question is, of course, how do you execute just the target method code? It’s an APK. How can you execute just the method you want with the inputs you want? How do you <em>harness</em> the target methods? There are two paths you can go by:</p>
<ol>
<li>Convert target DEX to a JAR using <a href="https://github.com/pxb1988/dex2jar" target="_blank" rel="external">dex2jar</a> or <a href="https://github.com/google/enjarify" target="_blank" rel="external">enjarify</a>. Then, import the JAR into a Java app and call the decryption code from your Java app.</li>
<li>Create a stub / driver app which takes command line arguments and can reflect methods in a DEX file. Then, execute the driver app + target DEX on an emulator.</li>
</ol>
<p>As it happens, I’ve already created <a href="https://github.com/CalebFenton/dex-oracle" target="_blank" rel="external">dex-oracle</a> which does #2. I like #2 more than #1 because it doesn’t rely on decompilers which often introduce subtle logic bugs. However, I’ve used #1 a few times in a pinch, so it’s worth mentioning. I went about adding support for this type of obfuscation to dex-oracle. the plugins were added in <a href="https://github.com/CalebFenton/dex-oracle/commit/cf44cd7aa5e81d5b0bc9588150b81a0fcdc575fe" target="_blank" rel="external">Add indexed string + class lookups</a>.</p>
<p>The way dex-oracle works is pretty simple. It contains a collection of plugins which define regular expressions which pull out key bits of information – method calls and arguments. Then, it constructs real method calls with the arguments you pull out and passes them to a driver which executes the original DEX file on an emulator. Finally, the plugin defines how the driver output should be used to modify the method.</p>
<p>For example, the regular expression could look for “a const number, a call to a static method which takes a number and returns a string, and moves the result to a register”. Then, the driver executes that method with the number and returns the decrypt string. Finally, the original string lookup code is replaced with just the decrypted string. You can read more about how it works in <a href="https://www.slideshare.net/tekproxy/tetcon-2016" target="_blank" rel="external">TetCon 2016 Android Deobfuscation Presentation</a>.</p>
<h2 id="dex-oracle-Before-Modification"><a href="#dex-oracle-Before-Modification" class="headerlink" title="dex-oracle Before Modification"></a>dex-oracle Before Modification</h2><p>Unfortunately, even with the new plugins, dex-oracle fails. To keep things simple, I disable all plugins except IndexStringLookup and I only process the <code>d</code> class from the picture example above.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">$ dex-oracle xjmurla.gqscntaej.bfdiays.apk --disable-plugins bitwiseantiskid,stringdecryptor,undexguard,unreflector,indexedclasslookup -i <span class="string">'/d'</span></div><div class="line">Invalid date/time <span class="keyword">in</span> zip entry</div><div class="line">Invalid date/time <span class="keyword">in</span> zip entry</div><div class="line">Invalid date/time <span class="keyword">in</span> zip entry</div><div class="line">Invalid date/time <span class="keyword">in</span> zip entry</div><div class="line">Invalid date/time <span class="keyword">in</span> zip entry</div><div class="line">Invalid date/time <span class="keyword">in</span> zip entry</div><div class="line">Invalid date/time <span class="keyword">in</span> zip entry</div><div class="line">Invalid date/time <span class="keyword">in</span> zip entry</div><div class="line">Invalid date/time <span class="keyword">in</span> zip entry</div><div class="line">Optimizing 11 methods over 23 Smali files.</div><div class="line">[WARN] 2017-10-28 12:28:45: Unsuccessful status: failure <span class="keyword">for</span> Error executing <span class="string">'static java.lang.String xjmurla.gqscntaej.bfdiays.f.a(int)'</span> with <span class="string">'I:839889519'</span></div><div class="line">java.lang.reflect.InvocationTargetException</div><div class="line">    at java.lang.reflect.Method.invokeNative(Native Method)</div><div class="line">    at java.lang.reflect.Method.invoke(Method.java:515)</div><div class="line">    at org.cf.oracle.Driver.invokeMethod(Driver.java:71)</div><div class="line">    at org.cf.oracle.Driver.main(Driver.java:131)</div><div class="line">    at com.android.internal.os.RuntimeInit.nativeFinishInit(Native Method)</div><div class="line">    at com.android.internal.os.RuntimeInit.main(RuntimeInit.java:243)</div><div class="line">    at dalvik.system.NativeStart.main(Native Method)</div><div class="line">Caused by: java.lang.NullPointerException</div><div class="line">    at xjmurla.gqscntaej.bfdiays.f.a(SourceFile:528)</div><div class="line">    ... 7 more</div><div class="line"></div><div class="line">// ** SNIP MANY SIMILAR ERRORS **</div><div class="line"></div><div class="line">Optimizations: string_lookups=13</div><div class="line">Invalid date/time <span class="keyword">in</span> zip entry</div><div class="line">// ** SNIP DUMB WARNINGS **</div><div class="line">Invalid date/time <span class="keyword">in</span> zip entry</div><div class="line">Time elapsed 1.954255 seconds</div></pre></td></tr></table></figure>
<p>The <code>Invalid date/time in zip entry</code> stuff is just noise. Maybe they tried obfuscating the timestamp in the ZIP? I dunno.</p>
<p>What concerns me is the <code>Unsuccessful status: failure for Error executing &#39;static java.lang.String xjmurla.gqscntaej.bfdiays.f.a(int)&#39; with &#39;I:839889519&#39;</code>. The error tells me there’s a <code>NullPointerException</code> when it executes <code>f.a(int)</code>. Looks like every time it tried to call that method, it failed. So, let’s look at <code>f.a(int)</code>.</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">.method</span><span class="keyword"> static</span> a(I)<span class="class">Ljava/lang/String;</span></div><div class="line"><span class="keyword">    .registers</span> 3</div><div class="line"></div><div class="line">   <span class="built_in"> sget-object </span>v0, <span class="class">Lxjmurla/gqscntaej/bfdiays/f;</span>-&gt;k:[<span class="class">Ljava/lang/String;</span></div><div class="line"></div><div class="line">   <span class="built_in"> const </span>v1, 0x320fb1f0</div><div class="line">   <span class="built_in"> sub-int </span>v1, p0, v1</div><div class="line">   <span class="built_in"> aget-object </span>v0, v0, v1</div><div class="line"></div><div class="line">   <span class="built_in"> return-object </span>v0<span class="keyword"></span></div><div class="line">.end method</div></pre></td></tr></table></figure>
<p>The entire method is pretty small. Just subtracts the first argument from a big constant and uses that as an index into a string array, <code>Lxjmurla/gqscntaej/bfdiays/f;-&gt;k:[Ljava/lang/String;</code>. Well, let’s look out <code>f;-&gt;k</code> is initialized.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ ag -Q <span class="string">'Lxjmurla/gqscntaej/bfdiays/f;-&gt;k:[Ljava/lang/String;'</span></div><div class="line">xjmurla/gqscntaej/bfdiays/Ceacabcbf.smali</div><div class="line">169:    sput-object v0, Lxjmurla/gqscntaej/bfdiays/f;-&gt;k:[Ljava/lang/String;</div><div class="line">245:    sget-object v0, Lxjmurla/gqscntaej/bfdiays/f;-&gt;k:[Ljava/lang/String;</div><div class="line">256:    sget-object v0, Lxjmurla/gqscntaej/bfdiays/f;-&gt;k:[Ljava/lang/String;</div><div class="line"></div><div class="line">xjmurla/gqscntaej/bfdiays/f.smali</div><div class="line">72:    sget-object v0, Lxjmurla/gqscntaej/bfdiays/f;-&gt;k:[Ljava/lang/String;</div></pre></td></tr></table></figure>
<p>There’s only one <code>sput-object</code> and it’s in <code>xjmurla/gqscntaej/bfdiays/Ceacabcbf.smali</code>. By looking for this line in <code>Ceacabcbf</code>, we find <code>private Ceacabcbf;-&gt;a()V</code>. This is a big, long, complicated method which contains a HUGE string literal which is processed, chunked up, and stored in <code>f;-&gt;k</code>. Hmm, our <code>NullPointerException</code> is caused by this field not getting initialized. This means that <code>Ceacabcbf;-&gt;a()V</code> is not getting called during execution of the string decryption method. Well, when <em>is</em> it called?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ ag -Q <span class="string">'Lxjmurla/gqscntaej/bfdiays/Ceacabcbf;-&gt;a()V'</span></div><div class="line">xjmurla/gqscntaej/bfdiays/Ceacabcbf.smali</div><div class="line">1313:    invoke-direct &#123;p0&#125;, Lxjmurla/gqscntaej/bfdiays/Ceacabcbf;-&gt;a()V</div></pre></td></tr></table></figure>
<p>Ahh, it’s only called in <code>Ceacabcbf</code>. Let’s find that.</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">.method</span><span class="keyword"> public</span> onCreate()V</div><div class="line"><span class="keyword">    .registers</span> 1</div><div class="line"></div><div class="line">   <span class="built_in"> invoke-super </span>&#123;p0&#125;, <span class="class">Landroid/app/Application;</span>-&gt;onCreate()V</div><div class="line"></div><div class="line">   <span class="built_in"> sput-object </span>p0, <span class="class">Lxjmurla/gqscntaej/bfdiays/Ceacabcbf;</span>-&gt;a:<span class="class">Lxjmurla/gqscntaej/bfdiays/Ceacabcbf;</span></div><div class="line"></div><div class="line">   <span class="built_in"> invoke-direct </span>&#123;p0&#125;, <span class="class">Lxjmurla/gqscntaej/bfdiays/Ceacabcbf;</span>-&gt;a()V</div><div class="line"></div><div class="line">   <span class="built_in"> return-void</span></div><div class="line"><span class="keyword">.end method</span></div></pre></td></tr></table></figure>
<p>It’s called in <code>Ceacabcbf;-&gt;onCreate()V</code>. This class is a subclass of <code>Application</code>. Without looking at the manifest, I’m pretty sure that when the app starts, this component is created, <code>onCreate()V</code> is called, the decrypted string array is built, and most importantly <code>f;-&gt;k</code> is initialized. Hmm, how can I make it so that dex-oracle calls this method when decrypting strings?</p>
<p>My first thought is to add a method call to <code>Ceacabcbf;-&gt;a()V</code> in <code>f;-&gt;&lt;clinit&gt;</code>. This ensures that when the string decryption class <code>f</code> is loaded, it initializes the decrypted string array. BUT, <code>a()V</code> is direct. WHAT TO DO?</p>
<p>Well, this is kind of dumb but it works sometimes. Just create a new public, static method called <code>Ceacabcbf;-&gt;init_decrypt()V</code> and copy the code from <code>Ceacabcbf;-&gt;a()V</code>. Then, add a line to call this method in <code>f;-&gt;&lt;clinit&gt;</code>:</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">.method</span><span class="keyword"> static</span><span class="keyword"> constructor</span> &lt;clinit&gt;()V</div><div class="line"><span class="keyword">    .registers</span> 1</div><div class="line"></div><div class="line">   <span class="built_in"> const/4 </span>v0, 0x0</div><div class="line">   <span class="built_in"> sput </span>v0, <span class="class">Lxjmurla/gqscntaej/bfdiays/f;</span>-&gt;a:I</div><div class="line">   <span class="built_in"> sput </span>v0, <span class="class">Lxjmurla/gqscntaej/bfdiays/f;</span>-&gt;d:I</div><div class="line">   <span class="built_in"> sput </span>v0, <span class="class">Lxjmurla/gqscntaej/bfdiays/f;</span>-&gt;e:I</div><div class="line">   <span class="built_in"> sput </span>v0, <span class="class">Lxjmurla/gqscntaej/bfdiays/f;</span>-&gt;f:I</div><div class="line"></div><div class="line">   <span class="built_in"> const/4 </span>v0, 0x4</div><div class="line">   <span class="built_in"> new-array </span>v0, v0, [<span class="class">Ljava/lang/String;</span></div><div class="line">   <span class="built_in"> sput-object </span>v0, <span class="class">Lxjmurla/gqscntaej/bfdiays/f;</span>-&gt;h:[<span class="class">Ljava/lang/String;</span></div><div class="line"></div><div class="line">   <span class="built_in"> const-string </span>v0, <span class="string">""</span></div><div class="line">   <span class="built_in"> sput-object </span>v0, <span class="class">Lxjmurla/gqscntaej/bfdiays/f;</span>-&gt;i:<span class="class">Ljava/lang/Object;</span></div><div class="line"></div><div class="line">     <span class="comment"># LOL MONEY, MONEY LOL</span></div><div class="line">   <span class="built_in"> invoke-static </span>&#123;&#125;, <span class="class">Lxjmurla/gqscntaej/bfdiays/Ceacabcbf;</span>-&gt;init_decrypt()V</div><div class="line"></div><div class="line">   <span class="built_in"> return-void</span></div><div class="line"><span class="keyword">.end method</span></div></pre></td></tr></table></figure>
<h2 id="dex-oracle-After-Modification"><a href="#dex-oracle-After-Modification" class="headerlink" title="dex-oracle After Modification"></a>dex-oracle After Modification</h2><p>After making some changes which hopefully work, need rebuild the DEX from the modified Smali and try dex-oracle on it.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ smali ass out -o xjmurla_mod1.dex</div><div class="line">$ dex-oracle xjmurla_mod1.dex --disable-plugins bitwiseantiskid,stringdecryptor,undexguard,unreflector,indexedclasslookup -i <span class="string">'/d'</span></div><div class="line">Optimizing 11 methods over 23 Smali files.</div><div class="line">Optimizations: string_lookups=13</div><div class="line">Time elapsed 2.034493 seconds</div></pre></td></tr></table></figure>
<p>No errors. Let’s see the decompilation.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ d2j-dex2jar.sh xjmurla_mod1_oracle.dex</div><div class="line">dex2jar xjmurla_mod1_oracle.dex -&gt; ./xjmurla_mod1_oracle-dex2jar.jar</div><div class="line">$ jd xjmurla_mod1_oracle-dex2jar.jar</div></pre></td></tr></table></figure>
<p><img src="/images/hacking-with-dex-oracle-for-android-malware-deobfuscation/d_partially_deobfuscated.png" alt="deobfuscated strings"></p>
<p>Oh, <em>hello there</em> Mr. C&amp;C domain! GET REKT BRO.</p>
<p><img src="/images/hacking-with-dex-oracle-for-android-malware-deobfuscation/get_rekt.gif" alt="get rekt"></p>
<p>Ok, but that still leaves the class deobfuscation. That’s still annoying, right? Well, to keep this post short, dex-oracle fails when deobbfuscating classes for the same reason as it originally failed for strings. The same <code>Ceacabcbf;-&gt;a()V</code> method needs to be called.</p>
<p>The same trick can be used – just call <code>Ceacabcbf;-&gt;init_decrypt()V</code> in <code>g;-&gt;&lt;clinit&gt;</code>. However, <code>g</code> doesn’t have a <code>&lt;clinit&gt;</code> so you’ll have to add one:</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">.method</span><span class="keyword"> static</span><span class="keyword"> constructor</span> &lt;clinit&gt;()V</div><div class="line"><span class="keyword">    .registers</span> 0</div><div class="line"></div><div class="line">   <span class="built_in"> invoke-static </span>&#123;&#125;, <span class="class">Lxjmurla/gqscntaej/bfdiays/Ceacabcbf;</span>-&gt;init_decrypt()V</div><div class="line">   <span class="built_in"> return-void</span></div><div class="line"><span class="keyword">.end method</span></div></pre></td></tr></table></figure>
<p>Now, rebuild and let dex-oracle do it’s thing:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ smali ass out -o xjmurla_mod2.dex</div><div class="line">$ dex-oracle xjmurla_mod2.dex  -i <span class="string">'/d'</span></div><div class="line">Optimizing 11 methods over 23 Smali files.</div><div class="line">Optimizations: string_decrypts=0, class_lookups=13, string_lookups=13</div><div class="line">Time elapsed 3.099335 seconds</div></pre></td></tr></table></figure>
<p>Let’s see if the decompilation looks any different.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ d2j-dex2jar.sh xjmurla_mod2_oracle.dex</div><div class="line">dex2jar xjmurla_mod1_oracle.dex -&gt; ./xjmurla_mod2_oracle-dex2jar.jar</div><div class="line">$ jd xjmurla_mod1_oracle-dex2jar.jar</div></pre></td></tr></table></figure>
<p><img src="/images/hacking-with-dex-oracle-for-android-malware-deobfuscation/d_deobfuscated.png" alt="deobfuscated strings and classes"></p>
<p>There’s not much difference for this method, but other methods have a lot more information, especially in the Smali where you can see lots of <code>const-class</code>es. There’s still one call to <code>g.c(int)</code> which isn’t deobfuscated. I found out that this is because the method call succeeds but returns <code>null</code>. Maybe that’s why it’s in a try-catch? Maybe it’s trying to load a class which doesn’t exist on every Android API version?</p>
<p>One final test: run it against the entire DEX file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ dex-oracle xjmurla_mod2.dex</div><div class="line">Optimizing 125 methods over 23 Smali files.</div><div class="line">Optimizations: string_decrypts=0, class_lookups=354, string_lookups=330</div><div class="line">Time elapsed 3.306326 seconds</div></pre></td></tr></table></figure>
<p>It worked. Cool. Now there are lots of strings! This should also make it a lot easier for Simplify to work because there’s less code to execute and fewer places to fail.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>Hopefully after reading this you have better idea of how to bend dex-oracle to suit your needs. It’s pretty flexible and great when you can isolate the code you need to run to a single method. Sometimes you need to make changes to an Android app to help dex-oracle, but modifying Smali is relatively easy to modify and a lot of malware doesn’t bother doing anti-tampering checks.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rednaga.io/2017/10/28/hacking-with-dex-oracle-for-android-malware-deobfuscation/" data-id="cj9c1b6yv0005bmupls6bmagg" class="article-share-link">Share</a>
      
        <a href="https://rednaga.io/2017/10/28/hacking-with-dex-oracle-for-android-malware-deobfuscation/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/deobfuscation/">deobfuscation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dex-oracle/">dex-oracle</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/malware/">malware</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2017/04/09/remote_kext_debugging/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Remote Kext Debugging (No, really - it worked!)</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/10/28/hacking-with-dex-oracle-for-android-malware-deobfuscation/">Hacking with dex-oracle for Android Malware Deobfuscation</a>
          </li>
        
          <li>
            <a href="/2017/04/09/remote_kext_debugging/">Remote Kext Debugging (No, really - it worked!)</a>
          </li>
        
          <li>
            <a href="/2016/11/14/hackingteam_back_for_your_androids/">HackingTeam back for your Androids, now extra insecure!</a>
          </li>
        
          <li>
            <a href="/2016/09/21/reversing_go_binaries_like_a_pro/">Reversing GO binaries like a pro</a>
          </li>
        
          <li>
            <a href="/2016/07/31/detecting_pirated_and_malicious_android_apps_with_apkid/">Detecting Pirated and Malicious Android Apps with APKiD</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
  <h3 class="widget-title">Pages</h3>
  <div class="widget pages">
    <a href="/team-rednaga">Team RedNaga</a>
  </div>
</div>

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/apkid/">apkid</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deobfuscation/">deobfuscation</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dex-oracle/">dex-oracle</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gdb/">gdb</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/">golang</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hackingteam/">hackingteam</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ida-pro/">ida pro</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/">kernel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kext/">kext</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lldb/">lldb</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/macos/">macos</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/malware/">malware</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/research/">research</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse-engineering/">reverse engineering</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/surveillance/">surveillance</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vmware/">vmware</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/apkid/" style="font-size: 15px;">apkid</a> <a href="/tags/deobfuscation/" style="font-size: 10px;">deobfuscation</a> <a href="/tags/dex-oracle/" style="font-size: 10px;">dex-oracle</a> <a href="/tags/gdb/" style="font-size: 10px;">gdb</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/hackingteam/" style="font-size: 10px;">hackingteam</a> <a href="/tags/ida-pro/" style="font-size: 15px;">ida pro</a> <a href="/tags/kernel/" style="font-size: 10px;">kernel</a> <a href="/tags/kext/" style="font-size: 10px;">kext</a> <a href="/tags/lldb/" style="font-size: 10px;">lldb</a> <a href="/tags/macos/" style="font-size: 10px;">macos</a> <a href="/tags/malware/" style="font-size: 10px;">malware</a> <a href="/tags/research/" style="font-size: 20px;">research</a> <a href="/tags/reverse-engineering/" style="font-size: 15px;">reverse engineering</a> <a href="/tags/surveillance/" style="font-size: 10px;">surveillance</a> <a href="/tags/vmware/" style="font-size: 10px;">vmware</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    <div id="twitter-feed" class="widget-wrap">
  <h3 class="widget-title">Twitter Feed</h3>
  <div class="widget">
    <a class="twitter-timeline" href="https://twitter.com/RedNagaSec">Tweets by RedNagaSec</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 RedNaga<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'rednaga';
  
  var disqus_url = 'https://rednaga.io/2017/10/28/hacking-with-dex-oracle-for-android-malware-deobfuscation/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>